/*
 * Class   : WS_RefreshTradelines
 * Purpose : This class invokes the services to get the latest information of tradelines from NuDebt org 
 * Author  : Financial Spectra
 */
public class WS_RefreshTradelines {
    
    private static final String PULL_OPP_DETAIL_SERVICE_URI = '/apexrest/pullOpportunitydetails';
    private List<String> mNuDebtOpportunityIds;
    
    private OpportunityJSONClass mResponse;
    
    public WS_RefreshTradelines(){}
    
    public void setRequest(List<String> pNuDebtOpportunityIds){
        mNuDebtOpportunityIds = pNuDebtOpportunityIds;
    }
    
    public void invoke(){
        if (mNuDebtOpportunityIds.isEmpty()){
            throw new CustomException('NuDebt Opportunity ID list is blank.');
        }
            
        String endPoint = 'callOut:' + WS_Constants.NUDEBT_ORG_NAMED_CRED;
        endPoint += PULL_OPP_DETAIL_SERVICE_URI;
        
        URL endPointURL = new URL(endPoint);
        
        String requestBody = JSON.serialize(mNuDebtOpportunityIds);
        System.debug(loggingLevel.ERROR, '-- Payload : ' + requestBody);
        
        HttpRequest httpReq = new HttpRequest();
        httpReq.setHeader('Content-Type','application/json');
        httpReq.setHeader('accept','application/json');
        httpReq.setEndpoint(endPointURL.toExternalForm());
        httpReq.setMethod(WS_Constants.POST);
        httpReq.setBody(requestBody);
        
        if (Test.isRunningTest()){ //AD DO NOT CALL CREDIT SERVICE WHILE RUNNING THE TEST
            String responseBody = '{"Opportunity":[{"UnsettledDebt":"13220.58","UnpaidProgramFeeWODNL":"120","TradeLines":[{"SFSCurrentBalance":"1195.09","SettelmentPayments":[{"TransactionMethod":"PHONE","TotalAmount":"81.20","ScheduleDate":"2018-09-27","PaymentType":"Withdrawal","Id":"a0I4100000BDE94EAH","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"81.17","ScheduleDate":"2018-10-27","PaymentType":"Withdrawal","Id":"a0I4100000BDE96EAH","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"81.17","ScheduleDate":"2018-11-27","PaymentType":"Withdrawal","Id":"a0I4100000BDE98EAH","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"81.17","ScheduleDate":"2018-12-27","PaymentType":"Withdrawal","Id":"a0I4100000BDE9AEAX","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"81.17","ScheduleDate":"2019-01-27","PaymentType":"Withdrawal","Id":"a0I4100000BDE9BEAX","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"81.17","ScheduleDate":"2019-02-27","PaymentType":"Withdrawal","Id":"a0I4100000BDE9CEAX","FileNumber":"00141000018BU1P","AttorneyPaymentId":""}],"OriginalDebt":"799.00","OriginalCreditorName":"Synchrony Bank","OriginalAccountNumber":"6044 2410 0591 3657","OfferStatus":"Accepted","OfferProgramFee":"199.75","OfferAmount":"478.05","NewAccountNumber":"6044241005913657","Name":"TL-00106562","Id":"a0Q41000009hoecEAA","FileNumber":"00141000018BU1P","DNLEstimatedSettlement":"40.03","CurrentStage":"Settled","AmountPaid":"0"},{"SettlementAmountPaid":"","OriginalDebt":"531.00","OriginalAccountNumber":"0536","OfferStatus":"","OfferProgramFee":"","OfferAmount":"","Name":"TL-00106563","Id":"a0Q41000009hoedEAA","FileNumber":"00141000018BU1P","DNLSettlementFees":"","DNLFundstoClient":"","DNLFundsforFees":"","DNLEstimatedSettlement":"50.00","DNLDisbursementDate":"","DNLDisbursementAmount":"","CurrentStage":"New","AmountPaid":""},{"SFSCurrentBalance":"5262.87","SettlementAmountPaid":"","OriginalDebt":"4619.00","OriginalAccountNumber":"2037","OfferStatus":"","OfferProgramFee":"","OfferAmount":"","Name":"TL-00106564","Id":"a0Q41000009hoeeEAA","FileNumber":"00141000018BU1P","DNLSettlementFees":"","DNLFundstoClient":"","DNLFundsforFees":"","DNLEstimatedSettlement":"50.00","DNLDisbursementDate":"","DNLDisbursementAmount":"","CurrentStage":"Offer Canceled","AmountPaid":""},{"SFSCurrentBalance":"7957.71","SettlementAmountPaid":"","OriginalDebt":"7293.00","OriginalAccountNumber":"5178 0597 2464 6675","OfferStatus":"","OfferProgramFee":"","OfferAmount":"","NewAccountNumber":"5178 0597 2464 6675","Name":"TL-00106565","Id":"a0Q41000009hoefEAA","FileNumber":"00141000018BU1P","DNLSettlementFees":"","DNLFundstoClient":"","DNLFundsforFees":"","DNLEstimatedSettlement":"50.00","DNLDisbursementDate":"","DNLDisbursementAmount":"","CurrentStage":"Offer Canceled","AmountPaid":""},{"SFSCurrentBalance":"2802.53","SettelmentPayments":[{"TransactionMethod":"PHONE","TotalAmount":"702.50","ScheduleDate":"2018-05-20","PaymentType":"Withdrawal","Id":"a0I41000009kNqmEAE","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"702.50","ScheduleDate":"2018-06-20","PaymentType":"Withdrawal","Id":"a0I41000009kNqoEAE","FileNumber":"00141000018BU1P","AttorneyPaymentId":""}],"OriginalDebt":"2424.00","OriginalAccountNumber":"4127 7777 0857 7773","OfferStatus":"Accepted","OfferProgramFee":"606.00","OfferAmount":"1402.00","Name":"TL-00106566","Id":"a0Q41000009hoelEAA","FileNumber":"00141000018BU1P","DNLEstimatedSettlement":"50.00","CurrentStage":"Settled","AmountPaid":"0"},{"SFSCurrentBalance":"2767.95","SettelmentPayments":[{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2018-06-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiWqEAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2018-07-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiWsEAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2018-08-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiWuEAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2018-09-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiWwEAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2018-10-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiWyEAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2018-11-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiX0EAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2018-12-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiX2EAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2019-01-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiX3EAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2019-02-28","PaymentType":"Withdrawal","Id":"a0I4100000AEiX4EAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2019-03-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiX5EAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2019-04-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiX6EAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""},{"TransactionMethod":"PHONE","TotalAmount":"174.50","ScheduleDate":"2019-05-30","PaymentType":"Withdrawal","Id":"a0I4100000AEiX7EAL","FileNumber":"00141000018BU1P","AttorneyPaymentId":""}],"OriginalDebt":"2160.00","OriginalAccountNumber":"6035340564946107","OfferStatus":"Accepted","OfferProgramFee":"540.00","OfferAmount":"2076.00","Name":"TL-00106567","Id":"a0Q41000009hoemEAA","FileNumber":"00141000018BU1P","DNLEstimatedSettlement":"50.00","CurrentStage":"Payment Plan Active","AmountPaid":"0"}],"TotalThirdPartyFee":"0.00","TotalServiceFee":"0.00","TotalRetainerFee":"0.00","TotalProgramFee":"4456.50","TotalProcessorFee":"394.20","TotalMaintenanceFee":"0.00","TotalAccumulation":"8378.22","SubscribedToALLG":"true","Stage":"Closed Won","Segment":"","SalesRep":"","ReoccurringDebitDay":"29","RemainingThirdPartyFee":"0.00","RemainingServiceFee":"0.00","RemainingRetainerFee":"0.00","RemainingProgramFee":"4456.50","RemainingProcessorFee":"214.00","RemainingMonths":"17","RemainingMaintenanceFee":"0.00","RemainingCreditorPayments":"0.00","RemainingAdminFee":"0.00","RemainingAccumulation":"2649.32","RecurringDebitDay":"29","ProgramType":"Timberline","ProgramStatus":"Active Client","ProgramName":"P-14529","ProgramLength":"36","ProgramId":"a0L41000007UMcwEAG","ProcessorName":"","PortfolioType":"Timberline","PersonMailingStreet":"150 E Warner Rd","PersonMailingState":"AZ","PersonMailingPostalCode":"85296","PersonMailingCountry":"US","PersonMailingCity":"Gilbert","PersonHomePhone":"(405) 808-48751234","PersonEmail":"chpatel@stratfs.com","PersonBirthDate":"1959-12-13","Payments":[{"TransactionStatus":"Cleared","TotalAmount":"332.42","ScheduleDate":"2017-11-24","PaymentType":"Deposit","paymentImportID":"","Name":"1430581","Id":"a0I41000006tALrEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2017-12-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430582","Id":"a0I41000006tALsEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-01-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430583","Id":"a0I41000006tALtEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-02-28","PaymentType":"Deposit","paymentImportID":"","Name":"1430584","Id":"a0I41000006tALuEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-03-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430585","Id":"a0I41000006tALvEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-04-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430586","Id":"a0I41000006tALwEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-05-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430587","Id":"a0I41000006tALxEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-06-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430588","Id":"a0I41000006tALyEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"400.00","ScheduleDate":"2018-07-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430589","Id":"a0I41000006tALzEAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-08-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430590","Id":"a0I41000006tAM0EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-09-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430591","Id":"a0I41000006tAM1EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-10-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430592","Id":"a0I41000006tAM2EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-11-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430593","Id":"a0I41000006tAM3EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2018-12-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430594","Id":"a0I41000006tAM4EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Scheduled","TotalAmount":"382.42","ScheduleDate":"2019-01-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430595","Id":"a0I41000006tAM5EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2019-02-28","PaymentType":"Deposit","paymentImportID":"","Name":"1430596","Id":"a0I41000006tAM6EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"382.42","ScheduleDate":"2019-03-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430597","Id":"a0I41000006tAM7EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-04-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430598","Id":"a0I41000006tAM8EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-05-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430599","Id":"a0I41000006tAM9EAM","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-06-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430600","Id":"a0I41000006tAMAEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-07-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430601","Id":"a0I41000006tAMBEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-08-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430602","Id":"a0I41000006tAMCEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-09-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430603","Id":"a0I41000006tAMDEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-10-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430604","Id":"a0I41000006tAMEEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-11-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430605","Id":"a0I41000006tAMFEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2019-12-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430606","Id":"a0I41000006tAMGEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-01-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430607","Id":"a0I41000006tAMHEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-02-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430608","Id":"a0I41000006tAMIEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-03-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430609","Id":"a0I41000006tAMJEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-04-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430610","Id":"a0I41000006tAMKEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-05-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430611","Id":"a0I41000006tAMLEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-06-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430612","Id":"a0I41000006tAMMEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-07-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430613","Id":"a0I41000006tAMNEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-08-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430614","Id":"a0I41000006tAMOEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-09-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430615","Id":"a0I41000006tAMPEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Pending","TotalAmount":"382.42","ScheduleDate":"2020-10-29","PaymentType":"Deposit","paymentImportID":"","Name":"1430616","Id":"a0I41000006tAMQEA2","FileNumber":"00141000018BU1P"},{"TransactionStatus":"Cleared","TotalAmount":"50.00","ScheduleDate":"2017-11-16","PaymentType":"Deposit","paymentImportID":"","Name":"1430739","Id":"a0I41000006tAPNEA2","FileNumber":"00141000018BU1P"}],"PaymentFrequency":"Monthly","PaymentAccountNumber":"","PaidProcessorFee":"180.20","PaidAccumulation":"5728.90","Name":"Tamara PTL-","MonthlyThirdPartyFees":"0.00","MonthlyProcessorFee":"10.95","LoanTerm":"42","LoanAmount":"10000.00","LawFirmName":"","LastName":"Weidemann","LastDraft":"382.42","Id":"00622000002tyGBAAY","FirstName":"Tamara","FileNumber":"00141000018BU1P","EnrollmentDate":"2017-11-15","DebtCount":"6","CurrentBalance":"942.62","CoDateOfBirth":"1900-01-01","CloseDate":"2019-05-06","ClientNumber":"CL-19119","ClientAge":"19.00","CashInDedicatedAccount":"2000.00","BoxFolderId":"43448615643","ApplicantState":"AZ","AddnlMonthsWithLoan":"12","AccountWorkPhone":"(405) 808-48751234","AccountSSN":"475744436","AccountName":"Tamara Weidemann"}]}';
            mResponse = OpportunityJSONClass.parse(responseBody);
        }else{
            System.debug(loggingLevel.ERROR, '-- HTTP Request : ' + httpReq);
            HttpResponse httpRes = (new Http()).send(httpReq);      
            System.debug(loggingLevel.ERROR, '-- HTTP Response : ' + httpRes);
            
            if (httpRes.getStatusCode() == 200){
                String responseBody = httpRes.getBody();
                System.debug(loggingLevel.ERROR, '-- RAW Response : ' + responseBody);
            
                if ('"{}"'.equals(responseBody)){
                    throw new CustomException('NuDebt returned the empty response, Please check the NuDebt OpportunityId.');
                }

                responseBody = responseBody.replace('\\','');
                responseBody = responseBody.removeStart('"').removeEnd('"');

                System.debug(loggingLevel.ERROR, '-- Cleaned Response : ' + responseBody);
                        
                mResponse = new OpportunityJSONClass();
                try{
                    mResponse = OpportunityJSONClass.parse(responseBody);
                    System.debug(loggingLevel.ERROR, '-- Response : ' + mResponse);
                } catch (Exception e){
                    mResponse = null;
                    System.debug(loggingLevel.ERROR, e.getMessage() + ' - ' + e.getStackTraceString());
                }
            }
        }
    }

    public OpportunityJSONClass getResponse(){
        return mResponse;
    }

}